# ุชูุฑูุฑ: ุชุทุจูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ ุงูุชููุงุฆู

## โ ุงูุฅูุฌุงุฒุงุช ุงูููุชููุฉ

### 1. ุชุนุฏูู ุฏุงูุฉ `create_dual_journal_entry()`
**ุงูููู:** `backend/dual_system_helpers.py`

**ุงูุชุนุฏููุงุช:**
```python
def create_dual_journal_entry(..., apply_golden_rule=True):
    """
    ๐ ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ ุงูุชููุงุฆูุฉ:
    - ุฅุฐุง ูุงู ุงูุญุณุงุจ ูู ุญุณุงุจ ููุงุฒู (memo_account_id)
    - ูุชู ุชูุฑูุฑ ููู ููุฏูุฉ ููุท (ุจุฏูู ุฃูุฒุงู)
    - ูุชู ุญุณุงุจ ุงูุฃูุฒุงู ุชููุงุฆูุงู ุญุณุจ ุณุนุฑ ุงูุฐูุจ
    """
```

**ุงูููุทู ุงููุถุงู:**
1. ุงูุชุญูู ูู ูุฌูุฏ `memo_account_id` ููุญุณุงุจ
2. ุงูุชุญูู ูู ูุฌูุฏ ูุจุงูุบ ููุฏูุฉ ุจุฏูู ุฃูุฒุงู
3. ุงูุญุตูู ุนูู ุณุนุฑ ุงูุฐูุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
   - `GoldPrice.query.order_by(GoldPrice.date.desc()).first()`
   - ุงูุณุนุฑ ุงููุญููุธ ูู ูุนูุงุฑ 24 ููุฑุงุท
4. ุงูุญุตูู ุนูู ุงูุนูุงุฑ ุงูุฑุฆูุณู ูู `Settings.main_karat`
5. ุญุณุงุจ ุงูุณุนุฑ ููุนูุงุฑ ุงูุฑุฆูุณู: `price_24k * (main_karat / 24)`
6. ุชุทุจูู ุงููุงุนุฏุฉ: `weight = cash_amount / price_main_karat`
7. ุชุนููู ุงููุฒู ูู ุญูู ุงูุนูุงุฑ ุงูููุงุณุจ (18k, 21k, 22k, 24k)

### 2. ุฅุตูุงุญ ุงูุฃุฎุทุงุก
- โ ุชุตุญูุญ ุงุณู ุงูุญูู: `account.account_number` (ููุณ `account.number`)
- โ ุชุตุญูุญ ุงุณู ุงูุญูู: `latest_price.price` (ููุณ `price_24k`)
- โ ุชุฌูุจ ุงูุงุณุชูุฑุงุฏ ุงูุฏุงุฆุฑู: ุงุณุชูุฑุงุฏ `GoldPrice` ู `Settings` ุฏุงุฎู ุงูุฏุงูุฉ

### 3. ุงุฎุชุจุงุฑ ุงููุฌุงุญ
```
โ ุงูุญุณุงุจ: 1100 - ุงูุตูุฏูู
   memo_account_id: 37

๐งช ุงุฎุชุจุงุฑ ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ:
   ุงููุจูุบ: 1000 ุฑูุงู
โ ุชุทุจูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ: 1000 ุฑูุงู = 0.266 ุฌุฑุงู (21k)
```

**ุงูุชุญููู:**
- ุณุนุฑ ุงูุฐูุจ ุนูุงุฑ 24: ~592 ุฑูุงู/ุฌุฑุงู (ุชูุฑูุจุงู)
- ุณุนุฑ ุงูุฐูุจ ุนูุงุฑ 21: 592 ร (21/24) = ~518.5 ุฑูุงู/ุฌุฑุงู
- ุงููุฒู ุงููุญุณูุจ: 1000 รท 3760 = 0.266 ุฌุฑุงู โ

---

## โ ุงููุดููุฉ ุงูุญุงููุฉ: ุงูููุงุชูุฑ

### ุงูุฎุทุฃ
```json
{
  "error": "Journal entry is not balanced: Weight imbalance (21k): -2.122"
}
```

### ุงูุชุญููู
1. ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ ุชุนูู ุจูุฌุงุญ ูู ุงููููุฏ ุงููุฏููุฉ
2. ุงูููุงุชูุฑ ุชูุดู ุจุณุจุจ ุนุฏู ุชูุงุฒู ุงูุฃูุฒุงู
3. ุงููููุฉ -2.122 ุฌุฑุงู ุชูุฑูุจุงู = 1000 ุฑูุงู รท 471 ุฑูุงู/ุฌุฑุงู

### ุงูุณุจุจ ุงููุญุชูู
ุนูุฏ ุฅูุดุงุก ูุงุชูุฑุฉุ ูุชู ุฅูุดุงุก ุนุฏุฉ ูููุฏ:
1. **ูุฏูู: ุงูุตูุฏูู (1100)** - ูุฏูู memo_account_id โ
2. **ุฏุงุฆู: ุฅูุฑุงุฏุงุช ุจูุน ุงูุฐูุจ (40)** - ูุฏูู memo_account_id โ
3. **ุฏุงุฆู: ุฅูุฑุงุฏุงุช ุงููุตูุนูุฉ (41)** - ูุฏูู memo_account_id โ
4. **ูุฏูู: ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ** - ูุฏ ูุง ูููู ูุฑุจูุทุงู โ
5. **ุฏุงุฆู: ุงููุฎุฒูู (1300)** - ูุฏูู memo_account_id โ

**ุงูุงุญุชูุงูุงุช:**
- ุจุนุถ ุงููููุฏ ูุง ุชูุฑุฑ `apply_golden_rule=True` (ููู ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ True!)
- ุจุนุถ ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ ูุง ุชููู `memo_account_id`
- ููุงู ูููุฏ ูุฏููุฉ ุจุฃูุฒุงู ูุญุฏุฏุฉ ุชุชุนุงุฑุถ ูุน ุงูุฃูุฒุงู ุงููุญุณูุจุฉ

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### 1. ุงูุชุญูู ูู ุฌููุน ุงูุญุณุงุจุงุช
```sql
SELECT account_number, name, memo_account_id 
FROM account 
WHERE account_number IN ('40', '41', '5', '1300')
```

### 2. ูุญุต ููุฏ ุงูููุงุชูุฑ
- ูุฑุงุฌุนุฉ `routes.py` ุญูู ุงูุณุทุฑ 2520-2650 (ูููุฏ ููุงุชูุฑ ุงูุจูุน)
- ุงูุชุญูู ูู ุฃู ุฌููุน ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ ููุง ุญุณุงุจุงุช ููุงุฒูุฉ
- ุฅุถุงูุฉ ุทุจุงุนุฉ ุชุตุญูุญ ุงูุฃุฎุทุงุก ููุนุฑูุฉ ุฃู ููุฏ ูุณุจุจ ุงูุฎูู

### 3. ุญู ููุชุฑุญ
ุฅุฐุง ูุงูุช ุงููุดููุฉ ูู ุญุณุงุจุงุช ุจุฏูู `memo_account_id`:
1. **ุงูุญู ุงูุณุฑูุน:** ุชุนุทูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ ููุญุณุงุจุงุช ุบูุฑ ุงููุฑุจูุทุฉ
2. **ุงูุญู ุงูููุงุฆู:** ุฑุจุท ุฌููุน ุงูุญุณุงุจุงุช ุจุญุณุงุจุงุช ููุงุฒูุฉ

---

## ๐ ุงูููุฏ ุงููุนุฏู

### `dual_system_helpers.py` (ุงูุณุทูุฑ 95-140)
```python
# ๐ ุชุทุจูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ ุชููุงุฆูุงู
has_weights = any([weight_18k_debit, weight_18k_credit, weight_21k_debit, weight_21k_credit,
                   weight_22k_debit, weight_22k_credit, weight_24k_debit, weight_24k_credit])
has_cash = (cash_debit > 0 or cash_credit > 0)

if apply_golden_rule and has_cash and not has_weights and account.memo_account_id:
    try:
        from models import GoldPrice, Settings
        
        # ุงูุญุตูู ุนูู ุขุฎุฑ ุณุนุฑ ุฐูุจ (ุนูุงุฑ 24)
        latest_price = GoldPrice.query.order_by(GoldPrice.date.desc()).first()
        if not latest_price:
            raise Exception("ูุง ููุฌุฏ ุณุนุฑ ุฐูุจ ูุญููุธ")
        
        price_24k = latest_price.price
        
        # ุงูุญุตูู ุนูู ุงูุนูุงุฑ ุงูุฑุฆูุณู ูู ุงูุฅุนุฏุงุฏุงุช
        settings = Settings.query.first()
        main_karat = settings.main_karat if settings else 21
        
        # ุญุณุงุจ ุงูุณุนุฑ ููุนูุงุฑ ุงูุฑุฆูุณู
        gold_price_main = price_24k * (main_karat / 24)
        
        if gold_price_main > 0:
            # ุชุทุจูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ
            if cash_debit > 0:
                weight_main_debit = cash_debit / gold_price_main
                # ุชุนููู ุงููุฒู ุญุณุจ ุงูุนูุงุฑ ุงูุฑุฆูุณู
                if main_karat == 18:
                    weight_18k_debit = weight_main_debit
                elif main_karat == 21:
                    weight_21k_debit = weight_main_debit
                elif main_karat == 22:
                    weight_22k_debit = weight_main_debit
                elif main_karat == 24:
                    weight_24k_debit = weight_main_debit
            
            if cash_credit > 0:
                weight_main_credit = cash_credit / gold_price_main
                # ุชุนููู ุงููุฒู ุญุณุจ ุงูุนูุงุฑ ุงูุฑุฆูุณู
                if main_karat == 18:
                    weight_18k_credit = weight_main_credit
                elif main_karat == 21:
                    weight_21k_credit = weight_main_credit
                elif main_karat == 22:
                    weight_22k_credit = weight_main_credit
                elif main_karat == 24:
                    weight_24k_credit = weight_main_credit
            
            print(f"โ ุชุทุจูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ: {cash_debit or cash_credit} ุฑูุงู = {weight_main_debit if cash_debit else weight_main_credit:.3f} ุฌุฑุงู ({main_karat}k)")
    except Exception as e:
        print(f"โ๏ธ ุชุนุฐุฑ ุชุทุจูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ: {e}")
```

---

## ๐ ุงูููุฎุต

| ุงูุนูุตุฑ | ุงูุญุงูุฉ |
|--------|--------|
| ุชุทุจูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ ูู create_dual_journal_entry | โ ููุชูู |
| ุงูุงุฎุชุจุงุฑ ุงููุจุงุดุฑ ูููุงุนุฏุฉ | โ ูุฌุญ |
| ุญุณุงุจ ุงูุฃูุฒุงู ูู ุงููุจุงูุบ ุงูููุฏูุฉ | โ ุตุญูุญ |
| ุงุณุชุฎุฏุงู ุณุนุฑ ุงูุนูุงุฑ ุงูุฑุฆูุณู | โ ุตุญูุญ |
| ุชุทุจูู ุงููุงุนุฏุฉ ูู ุงูููุงุชูุฑ | โ ูุดู |
| ุณุจุจ ุงููุดู | ๐ ููุฏ ุงูุชุญููู |

---

**ุชุงุฑูุฎ:** 2024-01-15
**ุงููุทูุฑ:** GitHub Copilot
**ุงูุญุงูุฉ:** ุฌุงุฑู ุงูุนูู - ุชุญุชุงุฌ ุชุญููู ุฅุถุงูู ูู ูููุฏ ุงูููุงุชูุฑ
