# نظام الصلاحيات والأدوار - ياسر للذهب

## نظرة عامة
تم تطبيق نظام صلاحيات متقدم يتكون من 4 أدوار رئيسية مع صلاحيات تفصيلية قابلة للتخصيص.

---

## الأدوار الأربعة

### 1. مسؤول النظام (System Admin) - `system_admin`
**الصلاحيات:** كاملة وغير محدودة

**المسؤوليات:**
- إدارة كاملة للمستخدمين (إضافة، تعديل، حذف، تغيير الصلاحيات)
- إعدادات النظام (اللوجو، الضرائب، إعدادات الطباعة، إلخ)
- النسخ الاحتياطي والاستعادة
- عرض جميع سجلات النظام
- تحكم كامل في جميع البيانات والعمليات
- تعيين/تعديل دور `system_admin` لمستخدمين آخرين

---

### 2. المدير (Manager) - `manager`
**الصلاحيات:** شاملة ما عدا إعدادات النظام الحرجة

**المسؤوليات:**
- ✅ إدارة الموظفين (إضافة، تعديل، حذف، رواتب، حوافز)
- ✅ اعتماد وإلغاء الفواتير
- ✅ تعديل/حذف فواتير الآخرين
- ✅ إدارة العملاء والموردين
- ✅ إدارة المخزون والأصناف
- ✅ تحديث أسعار الذهب
- ✅ عرض جميع التقارير المالية
- ✅ إنشاء وتعديل القيود المحاسبية
- ❌ لا يستطيع تغيير إعدادات النظام الأساسية
- ❌ لا يستطيع إدارة المستخدمين

---

### 3. المحاسب (Accountant) - `accountant`
**الصلاحيات:** محاسبية ومالية

**المسؤوليات:**
- ✅ إنشاء وتعديل الفواتير
- ✅ عرض وإضافة عملاء/موردين
- ✅ إنشاء وترحيل القيود المحاسبية
- ✅ إدارة السندات المالية
- ✅ عرض التقارير المالية
- ✅ طباعة الفواتير والتقارير
- ⚠️ عرض المخزون فقط (بدون تعديل)
- ❌ لا يستطيع حذف فواتير الآخرين
- ❌ لا يستطيع إدارة الموظفين
- ❌ لا يستطيع تعديل أسعار الذهب

---

### 4. الموظف (Employee) - `employee`
**الصلاحيات:** محدودة للعمليات اليومية

**المسؤوليات:**
- ✅ إنشاء فواتير بيع/شراء
- ✅ عرض فواتيره فقط
- ✅ عرض وإضافة عملاء
- ✅ عرض قائمة الأصناف
- ✅ عرض أسعار الذهب
- ✅ طباعة الفواتير
- ❌ لا يستطيع تعديل/حذف فواتير غيره
- ❌ لا يرى التقارير المالية
- ❌ لا يستطيع إدارة المخزون

---

## الصلاحيات التفصيلية

### إدارة المستخدمين والنظام
| الصلاحية | الكود | مسؤول | مدير | محاسب | موظف |
|---------|------|--------|------|-------|------|
| عرض المستخدمين | `users.view` | ✅ | ❌ | ❌ | ❌ |
| إضافة مستخدمين | `users.create` | ✅ | ❌ | ❌ | ❌ |
| تعديل المستخدمين | `users.edit` | ✅ | ❌ | ❌ | ❌ |
| حذف مستخدمين | `users.delete` | ✅ | ❌ | ❌ | ❌ |
| تغيير الصلاحيات | `users.change_permissions` | ✅ | ❌ | ❌ | ❌ |
| إعدادات النظام | `system.settings` | ✅ | ❌ | ❌ | ❌ |
| النسخ الاحتياطي | `system.backup` | ✅ | ❌ | ❌ | ❌ |
| سجلات النظام | `system.logs` | ✅ | ❌ | ❌ | ❌ |

### إدارة الموظفين
| الصلاحية | الكود | مسؤول | مدير | محاسب | موظف |
|---------|------|--------|------|-------|------|
| عرض الموظفين | `employees.view` | ✅ | ✅ | ❌ | ❌ |
| إضافة موظفين | `employees.create` | ✅ | ✅ | ❌ | ❌ |
| تعديل موظفين | `employees.edit` | ✅ | ✅ | ❌ | ❌ |
| حذف موظفين | `employees.delete` | ✅ | ✅ | ❌ | ❌ |
| إدارة الرواتب | `employees.payroll` | ✅ | ✅ | ❌ | ❌ |
| إدارة الحوافز | `employees.bonuses` | ✅ | ✅ | ❌ | ❌ |

### الفواتير
| الصلاحية | الكود | مسؤول | مدير | محاسب | موظف |
|---------|------|--------|------|-------|------|
| عرض الفواتير | `invoices.view` | ✅ | ✅ | ✅ | ✅ |
| إنشاء فواتير | `invoices.create` | ✅ | ✅ | ✅ | ✅ |
| تعديل الفواتير | `invoices.edit` | ✅ | ✅ | ✅ | ❌ |
| حذف الفواتير | `invoices.delete` | ✅ | ✅ | ✅ | ❌ |
| تعديل فواتير الآخرين | `invoices.edit_others` | ✅ | ✅ | ❌ | ❌ |
| حذف فواتير الآخرين | `invoices.delete_others` | ✅ | ✅ | ❌ | ❌ |
| اعتماد الفواتير | `invoices.approve` | ✅ | ✅ | ❌ | ❌ |
| إلغاء فواتير معتمدة | `invoices.cancel` | ✅ | ✅ | ❌ | ❌ |

### العملاء والموردين
| الصلاحية | الكود | مسؤول | مدير | محاسب | موظف |
|---------|------|--------|------|-------|------|
| عرض العملاء | `customers.view` | ✅ | ✅ | ✅ | ✅ |
| إضافة عملاء | `customers.create` | ✅ | ✅ | ✅ | ✅ |
| تعديل العملاء | `customers.edit` | ✅ | ✅ | ❌ | ❌ |
| حذف عملاء | `customers.delete` | ✅ | ✅ | ❌ | ❌ |
| عرض الموردين | `suppliers.view` | ✅ | ✅ | ✅ | ✅ |
| إضافة موردين | `suppliers.create` | ✅ | ✅ | ✅ | ❌ |
| تعديل الموردين | `suppliers.edit` | ✅ | ✅ | ❌ | ❌ |
| حذف موردين | `suppliers.delete` | ✅ | ✅ | ❌ | ❌ |

### المخزون والأصناف
| الصلاحية | الكود | مسؤول | مدير | محاسب | موظف |
|---------|------|--------|------|-------|------|
| عرض الأصناف | `items.view` | ✅ | ✅ | ✅ | ✅ |
| إضافة أصناف | `items.create` | ✅ | ✅ | ❌ | ❌ |
| تعديل الأصناف | `items.edit` | ✅ | ✅ | ❌ | ❌ |
| حذف أصناف | `items.delete` | ✅ | ✅ | ❌ | ❌ |
| تعديل المخزون | `items.adjust` | ✅ | ✅ | ❌ | ❌ |
| عرض أسعار الذهب | `gold_price.view` | ✅ | ✅ | ✅ | ✅ |
| تحديث أسعار الذهب | `gold_price.update` | ✅ | ✅ | ❌ | ❌ |

### المحاسبة
| الصلاحية | الكود | مسؤول | مدير | محاسب | موظف |
|---------|------|--------|------|-------|------|
| عرض الحسابات | `accounts.view` | ✅ | ✅ | ✅ | ❌ |
| إنشاء حسابات | `accounts.create` | ✅ | ❌ | ✅ | ❌ |
| تعديل الحسابات | `accounts.edit` | ✅ | ❌ | ✅ | ❌ |
| حذف حسابات | `accounts.delete` | ✅ | ❌ | ❌ | ❌ |
| عرض القيود | `journal.view` | ✅ | ✅ | ✅ | ❌ |
| إنشاء قيود | `journal.create` | ✅ | ✅ | ✅ | ❌ |
| تعديل القيود | `journal.edit` | ✅ | ✅ | ✅ | ❌ |
| حذف قيود | `journal.delete` | ✅ | ❌ | ❌ | ❌ |
| ترحيل القيود | `journal.post` | ✅ | ✅ | ✅ | ❌ |
| عرض السندات | `vouchers.view` | ✅ | ✅ | ✅ | ❌ |
| إنشاء سندات | `vouchers.create` | ✅ | ✅ | ✅ | ❌ |
| تعديل السندات | `vouchers.edit` | ✅ | ✅ | ✅ | ❌ |
| حذف سندات | `vouchers.delete` | ✅ | ❌ | ❌ | ❌ |

### التقارير
| الصلاحية | الكود | مسؤول | مدير | محاسب | موظف |
|---------|------|--------|------|-------|------|
| التقارير المالية | `reports.financial` | ✅ | ✅ | ✅ | ❌ |
| تقارير المخزون | `reports.inventory` | ✅ | ✅ | ❌ | ❌ |
| تقارير المبيعات | `reports.sales` | ✅ | ✅ | ✅ | ❌ |
| تقارير المشتريات | `reports.purchases` | ✅ | ✅ | ✅ | ❌ |
| تقارير العملاء | `reports.customers` | ✅ | ✅ | ✅ | ❌ |
| تقارير الموظفين | `reports.employees` | ✅ | ✅ | ❌ | ❌ |
| تقرير مركز الذهب | `reports.gold_position` | ✅ | ✅ | ✅ | ❌ |

### الطباعة
| الصلاحية | الكود | مسؤول | مدير | محاسب | موظف |
|---------|------|--------|------|-------|------|
| طباعة الفواتير | `print.invoices` | ✅ | ✅ | ✅ | ✅ |
| طباعة التقارير | `print.reports` | ✅ | ✅ | ✅ | ❌ |
| طباعة كشوف الحسابات | `print.statements` | ✅ | ✅ | ✅ | ❌ |

---

## البنية التقنية

### Backend (Python/Flask)

#### الملفات الجديدة:
1. **`permissions.py`**: تعريف الأدوار والصلاحيات
2. **`permissions_routes.py`**: API endpoints لإدارة الصلاحيات

#### التعديلات:
- **`models.py`**: تحديث `AppUser` ليدعم الأدوار الأربعة
- **`app.py`**: تسجيل permissions blueprint

#### API Endpoints الجديدة:
```
GET  /api/permissions/roles                  # قائمة الأدوار
GET  /api/permissions/all                    # جميع الصلاحيات مصنفة
GET  /api/permissions/role/<role_code>       # صلاحيات دور معين
GET  /api/users/<user_id>/permissions        # صلاحيات مستخدم
PUT  /api/users/<user_id>/permissions        # تحديث صلاحيات مستخدم
PUT  /api/users/<user_id>/role               # تحديث دور مستخدم
```

### Frontend (Flutter)

#### الملفات الجديدة:
1. **`models/permissions_model.dart`**: نماذج الأدوار والصلاحيات
2. **`screens/permissions_management_screen.dart`**: شاشة إدارة الصلاحيات

#### التعديلات:
- **`providers/auth_provider.dart`**: دوال فحص الصلاحيات المحسّنة
- **`api_service.dart`**: APIs الصلاحيات الجديدة
- **`models/app_user_model.dart`**: دعم الأدوار الجديدة

---

## الاستخدام

### في Backend:
```python
from models import AppUser
from permissions import has_permission

# فحص صلاحية مستخدم
user = AppUser.query.get(user_id)
if user.has_permission('invoices.delete'):
    # تنفيذ العملية
    pass

# في decorator
@token_required
@require_permission('users.edit')
def edit_user(current_user):
    pass
```

### في Flutter:
```dart
import 'package:provider/provider.dart';
import '../providers/auth_provider.dart';
import '../models/permissions_model.dart';

// فحص صلاحية
final auth = context.read<AuthProvider>();
if (auth.hasPermission(PermissionCodes.invoicesDelete)) {
  // إظهار زر الحذف
}

// فحص دور
if (auth.isManager) {
  // عرض خيارات المدير
}

// فتح شاشة إدارة الصلاحيات
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => PermissionsManagementScreen(
      user: selectedUser,
    ),
  ),
);
```

---

## الصلاحيات المخصصة

يمكن تخصيص صلاحيات أي مستخدم لتتجاوز الصلاحيات الافتراضية لدوره:

1. **منح صلاحية إضافية**: موظف يُمنح `reports.sales` ليرى تقارير المبيعات
2. **سحب صلاحية**: محاسب يُمنع من `invoices.delete` لحماية البيانات

---

## الأمان

1. **مسؤول النظام فقط** يمكنه:
   - تعيين/تعديل دور `system_admin`
   - تغيير صلاحيات مستخدم آخر
   - الوصول لإعدادات النظام

2. **المدير** يمكنه:
   - إدارة المستخدمين بأدوار أقل منه
   - اعتماد/إلغاء العمليات المالية

3. **الموظف** مقيد بـ:
   - فواتيره فقط
   - لا يرى البيانات المالية الحساسة

---

## الترقية من النظام القديم

### قاعدة البيانات:
```sql
-- تحديث الأدوار القديمة
UPDATE app_user SET role = 'system_admin' WHERE role = 'admin';
UPDATE app_user SET role = 'employee' WHERE role = 'staff';
```

### الكود:
- استبدل `is_admin` بـ `is_admin` (مسؤول نظام فقط)
- استخدم `isManager` للتحقق من دور المدير
- استبدل فحوصات الصلاحيات القديمة بـ `hasPermission()`

---

## الخلاصة

✅ **تم تطبيق نظام صلاحيات احترافي متكامل**
✅ **4 أدوار محددة بدقة**
✅ **80+ صلاحية تفصيلية**
✅ **واجهة إدارة سهلة في Flutter**
✅ **API آمن ومحمي في Backend**
✅ **قابل للتوسع والتخصيص**

---

تاريخ الإنشاء: 28 ديسمبر 2025
