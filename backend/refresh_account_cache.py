"""
ุชุญุฏูุซ cache ุญุณุงุจุงุช ุงูุดุฌุฑุฉ ุงููุฒุฏูุฌุฉ ูู ุงูุฐุงูุฑุฉ
ูุชู ุชุดุบููู ุนูุฏ ุจุฏุก ุงูุชุทุจูู ุฃู ุจุนุฏ ุชุญุฏูุซ ุงูุญุณุงุจุงุช
"""

from flask import current_app
from models import Account, db


def refresh_account_cache():
    """
    ุชุญุฏูุซ ุงูู cache ููุจุญุซ ุงูุณุฑูุน ุนู ุงูุญุณุงุจุงุช
    """
    from routes import _ACCOUNT_NUMBER_CACHE
    
    # ูุณุญ ุงูู cache ุงููุฏูู
    _ACCOUNT_NUMBER_CACHE.clear()
    
    # ุฌูุจ ุฌููุน ุงูุญุณุงุจุงุช ูุฅุถุงูุชูุง ููู cache
    all_accounts = Account.query.all()
    
    for account in all_accounts:
        if account.account_number:
            _ACCOUNT_NUMBER_CACHE[str(account.account_number)] = account.id
    
    print(f"โ ุชู ุชุญุฏูุซ cache ุงูุญุณุงุจุงุช: {len(_ACCOUNT_NUMBER_CACHE)} ุญุณุงุจ")
    return len(_ACCOUNT_NUMBER_CACHE)


def preload_critical_accounts():
    """
    ุชุญููู ุงูุญุณุงุจุงุช ุงูุญุฑุฌุฉ ูุณุจูุงู
    """
    from routes import get_account_id_by_number
    
    critical_accounts = [
        # ุงูุดุฌุฑุฉ ุงููุงููุฉ (ููุฏู)
        '1',      # ุงูุฃุตูู
        '11',     # ุงูุฃุตูู ุงููุชุฏุงููุฉ
        '110',    # ุงูููุฏูุฉ ูุงูุจููู
        '1100',   # ุงูุตูุฏูู
        '1110',   # ุจูู ุงูุฃููู
        '1120',   # ุจูู ุงูุฑุงุฌุญู
        '120',    # ุงูุนููุงุก
        '1200',   # ุนููุงุก ุจูุน ุฐูุจ
        '1210',   # ุนููุงุก ุดุฑุงุก ูุณุฑ
        '130',    # ุงููุฎุฒูู
        '1300',   # ูุฎุฒูู ุนูุงุฑ 18
        '1310',   # ูุฎุฒูู ุนูุงุฑ 21
        '1320',   # ูุฎุฒูู ุนูุงุฑ 22
        '1330',   # ูุฎุฒูู ุนูุงุฑ 24
        '2',      # ุงูุฎุตูู
        '21',     # ุงูููุฑุฏูู
        '210',    # ููุฑุฏู ุฐูุจ ุฎุงู
        '220',    # ููุฑุฏู ุฐูุจ ูุดุบูู
        '3',      # ุญููู ุงูููููุฉ
        '31',     # ุฑุฃุณ ุงููุงู
        '32',     # ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ
        '4',      # ุงูุฅูุฑุงุฏุงุช
        '40',     # ุฅูุฑุงุฏุงุช ุจูุน ุฐูุจ
        '41',     # ุฅูุฑุงุฏุงุช ูุตูุนูุฉ
        '5',      # ุงููุตุฑููุงุช
        '50',     # ุชูููุฉ ุงููุจูุนุงุช
        '51',     # ูุตุงุฑูู ุชุดุบูููุฉ
    '5110',   # ูุตุงุฑูู ูุธุงูุฉ
    '3600',   # ูุฑููุงุช ุชูููู ุงูุฐูุจ
        
        # ุดุฌุฑุฉ ุงููุฐูุฑุฉ (ูุฒูู)
        '7',      # ุงูุฃุตูู ุงููุฒููุฉ
        '71',     # ุงูุฃุตูู ุงููุชุฏุงููุฉ ุงููุฒููุฉ
        '710',    # ุงูููุฏูุฉ ุงููุฒููุฉ
        '7100',   # ุงูุตูุฏูู ุงููุฒูู
        '7110',   # ุจูู ูุฒูู
        '72',     # ุงูุฎุตูู ุงููุฒููุฉ
        '720',    # ุงูุนููุงุก ุงููุฒูููู
        '7200',   # ุนููุงุก ุจูุน ูุฒูู
        '7210',   # ุงูููุฑุฏูู ุงููุฒูููู
        '730',    # ุงููุฎุฒูู ุงููุฒูู
        '7300',   # ูุฎุฒูู ูุฒูู 18
        '7310',   # ูุฎุฒูู ูุฒูู 21
        '7320',   # ูุฎุฒูู ูุฒูู 22
        '7330',   # ูุฎุฒูู ูุฒูู 24
        '74',     # ุงูุฅูุฑุงุฏุงุช ุงููุฒููุฉ
        '7400',   # ุฅูุฑุงุฏุงุช ุจูุน ูุฒููุฉ
        '75',     # ุงููุตุฑููุงุช ุงููุฒููุฉ
        '7500',   # ุชูููุฉ ูุจูุนุงุช ูุฒููุฉ
        '7510',   # ูุตุงุฑูู ูุธุงูุฉ ูุฒููุฉ
        '7600',   # ูุฑููุงุช ุชูููู ูุฒููุฉ
    ]
    
    loaded = 0
    missing = []
    
    for acc_number in critical_accounts:
        acc_id = get_account_id_by_number(acc_number)
        if acc_id:
            loaded += 1
        else:
            missing.append(acc_number)
    
    if missing:
        print(f"โ๏ธ  ุงูุญุณุงุจุงุช ุงูููููุฏุฉ: {', '.join(missing)}")
    
    print(f"โ ุชู ุชุญููู {loaded}/{len(critical_accounts)} ุญุณุงุจ ุญุฑุฌ")
    return loaded, missing


def verify_dual_tree_integrity():
    """
    ุงูุชุญูู ูู ุณูุงูุฉ ุงูุดุฌุฑุฉ ุงููุฒุฏูุฌุฉ
    """
    issues = []
    
    # ุงูุชุญูู ูู ูุฌูุฏ ุงูุญุณุงุจุงุช ุงูุฑุฆูุณูุฉ ููุดุฌุฑุฉ ุงููุงููุฉ
    financial_parents = ['1', '11', '2', '21', '3', '31', '32', '4', '40', '41', '5', '50', '51']
    for parent in financial_parents:
        acc = Account.query.filter_by(account_number=parent, transaction_type='cash').first()
        if not acc:
            issues.append(f"ุงูุญุณุงุจ ุงูุฑุฆูุณู ุงููุงูู {parent} ููููุฏ")
    
    # ุงูุชุญูู ูู ูุฌูุฏ ุงูุญุณุงุจุงุช ุงูุฑุฆูุณูุฉ ูุดุฌุฑุฉ ุงููุฐูุฑุฉ
    memo_parents = ['7', '71', '72', '74', '75']
    for parent in memo_parents:
        acc = Account.query.filter_by(account_number=parent, transaction_type='gold').first()
        if not acc:
            issues.append(f"ุงูุญุณุงุจ ุงูุฑุฆูุณู ูููุฐูุฑุฉ {parent} ููููุฏ")
    
    # ุงูุชุญูู ูู ุนุฏุฏ ุงูุญุณุงุจุงุช
    cash_count = Account.query.filter_by(transaction_type='cash').count()
    gold_count = Account.query.filter_by(transaction_type='gold').count()
    
    print(f"๐ ุฅุญุตุงุฆูุงุช ุงูุดุฌุฑุฉ ุงููุฒุฏูุฌุฉ:")
    print(f"   - ุญุณุงุจุงุช ูุงููุฉ (cash): {cash_count}")
    print(f"   - ุญุณุงุจุงุช ูุฐูุฑุฉ (gold): {gold_count}")
    print(f"   - ุฅุฌูุงูู: {cash_count + gold_count}")
    
    if issues:
        print(f"\nโ๏ธ  ูุดุงูู ูู ุงูุดุฌุฑุฉ ุงููุฒุฏูุฌุฉ ({len(issues)}):")
        for issue in issues:
            print(f"   - {issue}")
        return False
    else:
        print("โ ุงูุดุฌุฑุฉ ุงููุฒุฏูุฌุฉ ุณูููุฉ ููุชูุงููุฉ")
        return True


if __name__ == '__main__':
    from app import app
    
    with app.app_context():
        print("=" * 60)
        print("๐ ุชุญุฏูุซ Cache ุงูุญุณุงุจุงุช")
        print("=" * 60)
        
        # 1. ุชุญุฏูุซ ุงูู cache
        cache_size = refresh_account_cache()
        
        # 2. ุชุญููู ุงูุญุณุงุจุงุช ุงูุญุฑุฌุฉ
        loaded, missing = preload_critical_accounts()
        
        # 3. ุงูุชุญูู ูู ุณูุงูุฉ ุงูุดุฌุฑุฉ
        is_valid = verify_dual_tree_integrity()
        
        print("=" * 60)
        if is_valid and not missing:
            print("โ ุฌููุน ุงูุฎุทูุงุช ูุฌุญุช - ุงููุธุงู ุฌุงูุฒ!")
        else:
            print("โ๏ธ  ููุงู ูุดุงูู ุชุญุชุงุฌ ุฅูู ุญู")
        print("=" * 60)
