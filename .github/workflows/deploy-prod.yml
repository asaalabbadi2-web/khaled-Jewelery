name: Deploy (Production)

on:
  workflow_run:
    workflows: ["Build & Push Docker Images"]
    branches: ["main"]
    types:
      - completed
  workflow_dispatch:

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    name: SSH deploy to VPS
    runs-on: ubuntu-latest

    # Only auto-deploy when the image build workflow succeeds
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add VPS to known_hosts
        shell: bash
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy via SSH (pull + up + migrate)
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          PROJECT_PATH: ${{ vars.PROJECT_PATH }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          GHCR_USERNAME: ${{ github.repository_owner }}
        run: |
          if [ -z "${PROJECT_PATH}" ]; then
            echo "Missing GitHub Variable: PROJECT_PATH" >&2
            echo "Set it in: Settings -> Secrets and variables -> Actions -> Variables" >&2
            exit 1
          fi

          ssh "${VPS_USER}@${VPS_HOST}" 'bash -se' <<EOF
          set -euo pipefail

          cd "${PROJECT_PATH}"

          test -f docker-compose.prod.images.yml
          test -f .env.production

          echo "${GHCR_PAT}" | docker login ghcr.io -u "${GHCR_USERNAME}" --password-stdin

          docker compose -f docker-compose.prod.images.yml --env-file .env.production pull
          docker compose -f docker-compose.prod.images.yml --env-file .env.production up -d
          docker compose -f docker-compose.prod.images.yml --env-file .env.production run --rm backend alembic upgrade head

          EOF
