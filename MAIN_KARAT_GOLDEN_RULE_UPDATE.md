# โ ุชุญุฏูุซ: ุงุณุชุฎุฏุงู ุณุนุฑ ุงูุนูุงุฑ ุงูุฑุฆูุณู ูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ

## ๐ ุงููุดููุฉ ุงูุณุงุจูุฉ

ูุงู ุงููุธุงู ูุณุชุฎุฏู **ุณุนุฑ ุนูุงุฑ 24** (ุซุงุจุช) ูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉุ ุจูููุง ุงูุนูุงุฑ ุงูุฑุฆูุณู **ูุชุบูุฑ** ููุฏ ูููู 21ุ 22ุ ุฃู 24 ุญุณุจ ุงูุฅุนุฏุงุฏุงุช.

## โ ุงูุญู ุงููุทุจู

ุชู ุชุญุฏูุซ ุงููุธุงู ููุณุชุฎุฏู **ุณุนุฑ ุงูุนูุงุฑ ุงูุฑุฆูุณู** (ุงููุญุฏุฏ ูู ุงูุฅุนุฏุงุฏุงุช) ุจุฏูุงู ูู ุนูุงุฑ 24.

---

## ๐ง ุงูุชุนุฏููุงุช ุงููููุฐุฉ

### 1๏ธโฃ **routes.py - ุฏุงูุฉ `get_current_gold_price()`**

```python
def get_current_gold_price():
    """
    Return latest gold price snapshot as SAR per gram.
    
    Returns:
        dict: Contains price_per_gram_24k, price_per_gram_main_karat, main_karat, source, updated_at
    """
    # ... ุญุณุงุจ price_per_gram_24k ...
    
    # ๐ ุญุณุงุจ ุณุนุฑ ุงูุนูุงุฑ ุงูุฑุฆูุณู
    main_karat = get_main_karat()  # ูู ุงูุฅุนุฏุงุฏุงุช (ุงูุชุฑุงุถู 21)
    price_per_gram_main_karat = (price_per_gram_24k * main_karat) / 24.0

    return {
        'price_per_gram_24k': round(price_per_gram_24k, 4),
        'price_per_gram_main_karat': round(price_per_gram_main_karat, 4),  # ๐
        'main_karat': main_karat,  # ๐
        'source': source,
        'updated_at': updated_at,
    }
```

**ุงูุชุบููุฑ:**
- โ ุฅุถุงูุฉ `price_per_gram_main_karat`: ุณุนุฑ ุงูุนูุงุฑ ุงูุฑุฆูุณู
- โ ุฅุถุงูุฉ `main_karat`: ูููุฉ ุงูุนูุงุฑ ุงูุฑุฆูุณู
- โ ุงูุญุณุงุจ: `ุณุนุฑ_ุงูุนูุงุฑ_ุงูุฑุฆูุณู = (ุณุนุฑ_24 ร ุงูุนูุงุฑ_ุงูุฑุฆูุณู) รท 24`

**ูุซุงู:**
```
ุฅุฐุง ูุงู:
- ุณุนุฑ ุนูุงุฑ 24: 518.48 ุฑูุงู/ุฌุฑุงู
- ุงูุนูุงุฑ ุงูุฑุฆูุณู: 21

ุณุนุฑ ุนูุงุฑ 21 = (518.48 ร 21) รท 24 = 453.67 ุฑูุงู/ุฌุฑุงู
```

---

### 2๏ธโฃ **dual_system_helpers.py - ุฏุงูุฉ `apply_golden_rule_to_line()`**

```python
def apply_golden_rule_to_line(line_data, gold_price_main_karat, main_karat=21, apply_rule=True):
    """
    ุชุทุจูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ ุนูู ุณุทุฑ ููุฏ ูุฏูู
    
    Args:
        line_data: ุจูุงูุงุช ุงูุณุทุฑ
        gold_price_main_karat: ุณุนุฑ ุงูุฐูุจ ููุนูุงุฑ ุงูุฑุฆูุณู  # ๐
        main_karat: ุงูุนูุงุฑ ุงูุฑุฆูุณู (ุงูุชุฑุงุถู 21ุ ูููู ูุงุจู ููุชุบููุฑ)  # ๐
        apply_rule: ุชุทุจูู ุงููุงุนุฏุฉ ุฃู ูุง
    """
    # ... ุงูุชุญูู ูู ุงูุจูุงูุงุช ...
    
    # ๐ ุชุญุฏูุฏ ุญูู ุงูุนูุงุฑ ุงูููุงุณุจ ุฏููุงููููุงู
    karat_field_debit = f'debit_{main_karat}k'
    karat_field_credit = f'credit_{main_karat}k'
    
    # ุชุทุจูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ
    if cash_debit > 0:
        weight_debit = cash_debit / gold_price_main_karat
        result[karat_field_debit] = round(weight_debit, 3)  # ๐ ุญูู ุฏููุงูููู
    
    if cash_credit > 0:
        weight_credit = cash_credit / gold_price_main_karat
        result[karat_field_credit] = round(weight_credit, 3)  # ๐ ุญูู ุฏููุงูููู
```

**ุงูุชุบููุฑุงุช:**
- โ ุฅุถุงูุฉ parameter `main_karat` ูุชุญุฏูุฏ ุงูุนูุงุฑ ุงูุฑุฆูุณู
- โ ุงุณุชุฎุฏุงู `gold_price_main_karat` ุจุฏูุงู ูู `gold_price_24k`
- โ ุชุณุฌูู ุงููุฒู ูู ุญูู ุงูุนูุงุฑ ุงูุฑุฆูุณู ุฏููุงููููุงู (`debit_21k`, `debit_22k`, ุฅูุฎ)

---

### 3๏ธโฃ **routes.py - endpoint `POST /api/journal_entries`**

```python
if apply_golden_rule:
    from dual_system_helpers import apply_golden_rule_to_line
    gold_price_data = get_current_gold_price()
    gold_price_main_karat = gold_price_data['price_per_gram_main_karat']  # ๐
    main_karat = gold_price_data['main_karat']  # ๐
    
    # ุชุทุจูู ุงููุงุนุฏุฉ ุนูู ูู ุณุทุฑ
    lines_data = [
        apply_golden_rule_to_line(line, gold_price_main_karat, main_karat, apply_rule=True)  # ๐
        for line in lines_data
    ]
    
    print(f"โ ุชู ุชุทุจูู ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ (ุณุนุฑ ุนูุงุฑ {main_karat}: {gold_price_main_karat} ุฑูุงู/ุฌุฑุงู)")
```

**ุงูุชุบููุฑุงุช:**
- โ ุงุณุชุฎุฏุงู `price_per_gram_main_karat` ูู ุงูุงุณุชุฌุงุจุฉ
- โ ุชูุฑูุฑ `main_karat` ุฅูู ุงูุฏุงูุฉ
- โ ุฑุณุงูุฉ ุชูุถุญ ุงูุนูุงุฑ ุงููุณุชุฎุฏู

---

### 4๏ธโฃ **routes.py - endpoint `GET /api/gold_price`**

```python
@api.route('/gold_price', methods=['GET'])
def get_gold_price():
    # ... ุฌูุจ ุงูุณุนุฑ ูู API ุฃู ูุงุนุฏุฉ ุงูุจูุงูุงุช ...
    
    # ๐ ุญุณุงุจ ุณุนุฑ ุงูุนูุงุฑ ุงูุฑุฆูุณู
    main_karat = get_main_karat()
    price_main_karat = (price_per_gram_sar * main_karat) / 24.0
    
    return jsonify({
        'price_24k': round(price_per_gram_sar, 2),
        'price_main_karat': round(price_main_karat, 2),  # ๐
        'main_karat': main_karat,  # ๐
        'price_usd_per_oz': price_usd,
        'currency': 'ุฑ.ุณ',
        'date': datetime.now().isoformat(),
        'source': 'API'
    })
```

**ุงูุชุบููุฑุงุช:**
- โ ุฅุถุงูุฉ `price_main_karat` ููุงุณุชุฌุงุจุฉ
- โ ุฅุถุงูุฉ `main_karat` ููุงุณุชุฌุงุจุฉ

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ูุจู ุงูุชุนุฏูู:
```
ุงูุณุนุฑ ุงููุณุชุฎุฏู: 518.48 ุฑูุงู/ุฌุฑุงู (ุนูุงุฑ 24 - ุซุงุจุช)
ุงููุจูุบ: 1000 ุฑูุงู
ุงููุฒู = 1000 รท 518.48 = 1.929 ุฌุฑุงู โ
```

### ุจุนุฏ ุงูุชุนุฏูู:
```
ุงูุณุนุฑ ุงููุณุชุฎุฏู: 453.67 ุฑูุงู/ุฌุฑุงู (ุนูุงุฑ 21 - ุงูุนูุงุฑ ุงูุฑุฆูุณู)
ุงููุจูุบ: 1000 ุฑูุงู
ุงููุฒู = 1000 รท 453.67 = 2.204 ุฌุฑุงู โ
```

---

## ๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ

```bash
python test_manual_entries_golden_rule.py
```

**ุงููุชูุฌุฉ:**
```
๐ฐ ุณุนุฑ ุงูุฐูุจ ุนูุงุฑ 21: 453.67 ุฑูุงู/ุฌุฑุงู
๐ต ุงููุจูุบ ุงูููุฏู: 1000.0 ุฑูุงู
โ๏ธ  ุงููุฒู ุงููุชููุน: 2.204 ุฌุฑุงู

โ ุชู ุฅูุดุงุก ุงูููุฏ #9
   ูุฏูู ูุฒูู (21k): 2.204 ุฌุฑุงู โ
   ุฏุงุฆู ูุฒูู (21k): 2.204 ุฌุฑุงู โ
```

---

## ๐ฏ ุงูููุงุฆุฏ

1. โ **ูุฑููุฉ:** ูุนูู ูุน ุฃู ุนูุงุฑ ุฑุฆูุณู (18ุ 21ุ 22ุ 24)
2. โ **ุฏูุฉ:** ูุณุชุฎุฏู ุงูุณุนุฑ ุงูุตุญูุญ ููุนูุงุฑ ุงูุฑุฆูุณู
3. โ **ุชููุงุฆู:** ูุณุฌู ูู ุญูู ุงูุนูุงุฑ ุงูุตุญูุญ
4. โ **ูุงุจู ููุชูููู:** ุงูุนูุงุฑ ุงูุฑุฆูุณู ูู ุงูุฅุนุฏุงุฏุงุช

---

## ๐ ุงุณุชุฎุฏุงู ูุน ุนูุงุฑุงุช ูุฎุชููุฉ

### ูุซุงู 1: ุนูุงุฑ 21 (ุงูุงูุชุฑุงุถู)
```json
{
  "price_24k": 518.48,
  "price_main_karat": 453.67,  // (518.48 ร 21) รท 24
  "main_karat": 21
}
```

### ูุซุงู 2: ุนูุงุฑ 22
```json
{
  "price_24k": 518.48,
  "price_main_karat": 475.27,  // (518.48 ร 22) รท 24
  "main_karat": 22
}
```

### ูุซุงู 3: ุนูุงุฑ 18
```json
{
  "price_24k": 518.48,
  "price_main_karat": 388.86,  // (518.48 ร 18) รท 24
  "main_karat": 18
}
```

---

## ๐ ุชุบููุฑ ุงูุนูุงุฑ ุงูุฑุฆูุณู

```bash
# ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช
PUT /api/settings
{
  "main_karat": 22
}

# ุณูุคุซุฑ ุนูู:
โ ุญุณุงุจ ุงูุฃุณุนุงุฑ
โ ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ
โ ุญููู ุงูุชุณุฌูู (debit_22k, credit_22k)
```

---

## โ ุงูููุฎุต

| ุงูุนูุตุฑ | ูุจู | ุจุนุฏ |
|--------|-----|-----|
| ุงูุณุนุฑ ุงููุณุชุฎุฏู | ุนูุงุฑ 24 (ุซุงุจุช) | ุงูุนูุงุฑ ุงูุฑุฆูุณู (ูุชุบูุฑ) |
| ุญูู ุงูุชุณุฌูู | `debit_21k` (ุซุงุจุช) | `debit_{main_karat}k` (ุฏููุงูููู) |
| ุงููุฑููุฉ | ููุฎูุถุฉ | ุนุงููุฉ |
| ุงูุฏูุฉ | โ ุบูุฑ ุฏููู | โ ุฏููู |

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 14 ุฏูุณูุจุฑ 2025  
**ุงูุญุงูุฉ:** โ ููุชูู ููุฎุชุจุฑ  
**ุงููููุงุช ุงููุนุฏูุฉ:** 4 (routes.py, dual_system_helpers.py, test_manual_entries_golden_rule.py)
